#' Run this before upgrading to 4.0.0.
#'
#' This function deletes all files in \file{man/} and flags \file{NAMESPACE}
#' as being safe to override. Run this once before you upgrade to roxygen2
#' 4.0.0 and NEVER AGAIN.
#'
#' @param path Package path to upgrade. Defaults to working directory.
#' @export
upgradeRoxygen <- function(path = ".") {
  desc <- file.path(path, "DESCRIPTION")
  if (!file.exists(desc)) {
    stop("Doesn't look like a package", call. = FALSE)
  }

  message("This will delete all files in man/. Backup any hand-created\n",
    "files by hand before continuing. Ready?")
  if (menu(c("Yes", "No")) != 1) return()

  # Delete all old Rd files
  man <- dir(file.path(path, "man"), full.names = TRUE)
  unlink(man)

  # Flag namespace as ok
  namespace <- file.path(path, "NAMESPACE")
  if (!file.exists(namespace)) return()

  lines <- readLines(namespace)
  writeLines(c(made_by("#"), lines), namespace)
}

first_time_check <- function(path) {
  rd <- dir(file.path(path, "man"), full.names = TRUE)
  if (length(rd) == 0) return()

  roxy <- vapply(rd, made_by_roxygen, logical(1))
  if (all(!roxy)) {
    stop("Looks like this is your first time using roxygen2 > 4.0.0.\n",
      "Please run roxygen2::upgradeRoxygen().",
      call. = FALSE)
  }
}

made_by_roxygen <- function(path) {
  if (!file.exists(path)) return(TRUE)

  first <- readLines(path, n = 1)
  check_made_by(first)
}

check_made_by <- function(first) {
  if (length(first) == 0L) return(FALSE)
  grepl("^. Generated by roxygen2", first)
}

made_by <- function(comment) {
  paste0(comment, " Generated by roxygen2 (", packageVersion("roxygen2"),
    "): do not edit by hand\n")
}
